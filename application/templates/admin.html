{% extends 'index.html' %}

{% block content %}
<div class="panel">
		<header class="admin-header">
			<h2>Admin â€” Chat logs</h2>
			<div class="admin-controls">
				<label for="user-select" class="muted">User:</label>
				<select id="user-select" class="admin-select"></select>
				<button id="refresh-logs" class="admin-btn admin-btn-secondary" title="Refresh logs">ğŸ”„ Refresh</button>
				<button id="export-btn" class="admin-btn admin-btn-primary" title="Export CSV">ğŸ“¥ Export</button>
				<button id="clear-btn" class="admin-btn admin-btn-danger" title="Clear events">ğŸ—‘ï¸ Clear</button>
			</div>
		</header>

	<section class="admin-logs-section">
		{% if transcript %}
			<p class="muted">Showing {{ transcript|length }} entries (most recent first)</p>
			<div class="table-container">
				<table class="admin-table">
					<thead>
						<tr>
							<th>Type</th>
							<th>Content</th>
							<th>Timestamp</th>
						</tr>
					</thead>
					<tbody>
						{% for line in transcript %}
							<tr>
								<td>{{ line.split('</b>')[0].replace('<b>', '').replace(':', '') }}</td>
								<td>{{ line.split('</b>')[1].split('<small>')[0].strip() }}</td>
								<td>{{ line.split('<small>(')[1].replace(')</small>', '') }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<p class="muted">No log entries found for this user.</p>
		{% endif %}
	</section>
</div>

<script>
document.getElementById('refresh-logs')?.addEventListener('click', async ()=>{
	// Re-fetch /admin and replace <main> content via the router-friendly approach
	try{
		const res = await fetch(location.pathname, {headers:{'X-Requested-With':'XMLHttpRequest'}});
		const text = await res.text();
		const parser = new DOMParser();
		const doc = parser.parseFromString(text, 'text/html');
		const newMain = doc.querySelector('main');
		if(newMain){ document.querySelector('main').innerHTML = newMain.innerHTML; }
	}catch(e){ console.error(e); location.reload(); }
});
</script>

{% endblock %}